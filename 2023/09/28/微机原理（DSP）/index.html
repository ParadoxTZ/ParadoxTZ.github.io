<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>微机原理（DSP）笔记 | Paradox's Website</title><meta name="author" content="Paradox,420907574@qq.com"><meta name="copyright" content="Paradox"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="微机原理及其应用（XXD老师班）笔记"><meta property="og:type" content="article"><meta property="og:title" content="微机原理（DSP）笔记"><meta property="og:url" content="http://zju-paradox.top/2023/09/28/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%EF%BC%88DSP%EF%BC%89/index.html"><meta property="og:site_name" content="Paradox&#39;s Website"><meta property="og:description" content="微机原理及其应用（XXD老师班）笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img2.baidu.com/it/u=1235612171,3868693941&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=281"><meta property="article:published_time" content="2023-09-28T07:20:05.291Z"><meta property="article:modified_time" content="2023-12-05T11:36:32.928Z"><meta property="article:author" content="Paradox"><meta property="article:tag" content="笔记"><meta property="article:tag" content="大三"><meta property="article:tag" content="电气"><meta property="article:tag" content="微机"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img2.baidu.com/it/u=1235612171,3868693941&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=281"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://zju-paradox.top/2023/09/28/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%EF%BC%88DSP%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Paradox","link":"链接: ","source":"来源: Paradox's Website","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"微机原理（DSP）笔记",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-12-05 19:36:32"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/dog.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-pen-to-square"></i> <span>说说</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/image/top3.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="Paradox's Website"><span class="site-name">Paradox's Website</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-images"></i> <span>图库</span></a></div><div class="menus_item"><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-pen-to-square"></i> <span>说说</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">微机原理（DSP）笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-28T07:20:05.291Z" title="发表于 2023-09-28 15:20:05">2023-09-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-05T11:36:32.928Z" title="更新于 2023-12-05 19:36:32">2023-12-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AF%BE%E7%A8%8B/">课程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="微机原理（DSP）笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/09/28/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%EF%BC%88DSP%EF%BC%89/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="课程笔记">课程笔记</h1><h2 id="时钟与系统控制">时钟与系统控制</h2><table><colgroup><col style="width:9%"><col style="width:6%"><col style="width:32%"><col style="width:51%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>外部</td><td>OSCCLK</td><td>外部晶振信号</td><td></td></tr><tr class="even"><td>时钟控制</td><td>PLLCR</td><td>提供倍数于参考信号的系统时钟</td><td><span class="math inline">\(\text{SYSCLK}=\frac{f\cdot\text{PLLCR}}2\)</span></td></tr><tr class="odd"><td></td><td>PCLKCR</td><td>外设时钟信号</td><td></td></tr><tr class="even"><td></td><td>HISPCP</td><td>高速时钟信号</td><td></td></tr><tr class="odd"><td></td><td>LOSPCP</td><td>低速时钟信号</td><td></td></tr><tr class="even"><td>看门狗</td><td>WDCR</td><td>看门狗时钟寄存器</td><td>含使能控制、逻辑校验位、频率设置</td></tr><tr class="odd"><td></td><td>SCSR</td><td>系统控制和状态寄存器</td><td>含WDINTS（中断状态位）、WDENNIT（中断使能位）</td></tr><tr class="even"><td>低功耗</td><td>LPMCR0</td><td>低功耗控制寄存器0</td><td>低二位LPM控制低功耗模式，QUALSTDBY控制频率</td></tr><tr class="odd"><td></td><td>LPMCR1</td><td>低功耗控制寄存器1</td><td>低八位控制STDBY模式的唤醒（全1唤醒）</td></tr></tbody></table><h2 id="gpio">GPIO</h2><table><colgroup><col style="width:16%"><col style="width:11%"><col style="width:29%"><col style="width:43%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>控制寄存器</td><td>GPxMUX</td><td>功能选择控制寄存器</td><td>‘0’ - I/O；‘1’ - 外设</td></tr><tr class="even"><td></td><td>GPxDIR</td><td>方向控制寄存器</td><td>‘0’ - Input；‘1’ - Output</td></tr><tr class="odd"><td></td><td>GPxQUAL</td><td>输入限定控制</td><td>使输入在n个采样相同时才变化</td></tr><tr class="even"><td>数据寄存器</td><td>GPxDAT</td><td>数据寄存器</td><td>16位</td></tr></tbody></table><h2 id="cpu定时器">CPU定时器</h2><table><colgroup><col style="width:12%"><col style="width:10%"><col style="width:16%"><col style="width:61%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>减法计数</td><td>TIMER0TIM</td><td>计数器寄存器</td><td>32位减法计数器，减到0产生中断（控制寄存器）</td></tr><tr class="even"><td></td><td>TIMER0TIMH</td><td></td><td>与上面的合起来</td></tr><tr class="odd"><td>赋值（高位）</td><td>TIMER0PRD</td><td>周期寄存器</td><td>定义为<code>long int*</code>，可以直接实现两个一起赋值，最大4G</td></tr><tr class="even"><td></td><td>TIMER0PRDH</td><td></td><td>合起来的话，在上面那个地方赋值</td></tr><tr class="odd"><td>控制</td><td>TIMER0PCR</td><td>控制寄存器</td><td>15位 - 中断标志位，计数器减到0置1，否则为0，写入1清零<br>5位 - 定时器重装，写1时重装PRD和TDDR(TPR)的值</td></tr><tr class="even"><td>赋值（低位）</td><td>TIMER0TPR</td><td>预定标寄存器</td><td>必须分两块写入数据，每块16位最大256 bit</td></tr><tr class="odd"><td></td><td>TIMER0TPRH</td><td></td><td>跟上面那个都定义为<code>unsigned int*</code></td></tr><tr class="even"><td>控制</td><td>TIMER0TCR</td><td>定时器控制寄存器</td><td>第15位 - 中断标志位。定时器到0时置1，写入1清零</td></tr></tbody></table><p>因此：<br> <span class="math display">\[ T=\frac{\text{TDDRH:TDDR}+1}{\text{SYSCLKOUT}(Hz)}\cdot(\text{PRDH:PRD}+1) \]</span></p><h2 id="中断">中断</h2><table><colgroup><col style="width:9%"><col style="width:9%"><col style="width:32%"><col style="width:49%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>CPU中断</td><td>IER</td><td>中断使能寄存器（16位）</td><td>‘0’ - 禁止；‘1’ - 使能</td></tr><tr class="even"><td></td><td>IFR</td><td>中断标志寄存器（16位）</td><td>‘0’ - 清零；‘1’ - 中断</td></tr><tr class="odd"><td></td><td>INTM</td><td>全局中断使能寄存器</td><td>‘1’ - 全局使能</td></tr><tr class="even"><td>PIE中断</td><td>PIRIER</td><td>PIE中断使能寄存器（12×8）</td><td>同上</td></tr><tr class="odd"><td></td><td>PIEIFR</td><td>PIE中断标志寄存器（12×8）</td><td>同上</td></tr><tr class="even"><td></td><td>PIEACK</td><td>PIE中断应答寄存器</td><td>不确定几位，清0申请中断，置1为等待状态</td></tr><tr class="odd"><td></td><td>PIECTRL</td><td>PIE控制寄存器</td><td>ENPIE，位0，置1表示向量取自PIE向量表</td></tr></tbody></table><h2 id="存储器与寄存器">存储器与寄存器</h2><h3 id="存储器与cmd">存储器与CMD</h3><p>CMD：记录下如何分配存储空间内容的文件</p><p>CMD的工作分为两步：</p><ol type="1"><li>MEMORY：指示定义存储空间</li><li>SECTIONS：分配存储空间</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SRAM.CMD */</span></span><br><span class="line">MEMORY&#123;</span><br><span class="line">    PAGE <span class="number">1</span>: <span class="comment">// PAGE0表示程序空间，PAGE1表示数据空间</span></span><br><span class="line">    	SPI_A	:origin=<span class="number">0x007740</span>, length=<span class="number">0x000010</span></span><br><span class="line">    <span class="comment">//   名称    起始地址           长度</span></span><br><span class="line">    <span class="comment">// 相当于在仓库（存储空间）里开了一个大集装箱，名叫SPI_A，并告诉大家这块箱子在哪，能装多少东西</span></span><br><span class="line">&#125;</span><br><span class="line">SECTIONS&#123;</span><br><span class="line">    SciaRegsFile	:&gt;SCI_A,	PAGE=<span class="number">1</span></span><br><span class="line">    <span class="comment">// 输出段名称      地址（绝对地址或地址名）</span></span><br><span class="line">    <span class="comment">// 以后公司采购，分类为SpiaRegsFile的数据（PAGE=1）都会被丢到SPI_A的箱子里</span></span><br><span class="line">    <span class="comment">// 因此，以后就不用管箱子叫啥了，直接把东西归类为SpiaRegsFile，我们称之为“段”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在C语音中已经预先定义好了很多<strong>“段”</strong>，我们可以直接拿来用，或者我们可以自己新建或定义“段”，用于存放我们所需要的<strong>变量</strong>。方法如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 写法 */</span></span><br><span class="line"><span class="meta">#progma DATA_SECTION(<span class="string">&lt;variables&gt;</span>,<span class="string">&quot;&lt;section_name&gt;&quot;</span>);</span></span><br><span class="line">struction variables;</span><br><span class="line"><span class="comment">/* 解释 */</span></span><br><span class="line"><span class="comment">// DATA_SECTION 定义数据段，CODE_SECTION 定义程序段</span></span><br><span class="line"><span class="comment">// &lt;variables&gt; 是变量名，如s；&lt;section_name&gt;是段名，如上文的SciaRegsFile</span></span><br><span class="line"><span class="comment">// 下面一行是常见的变量定义，如：unsigned int s[100];</span></span><br><span class="line"><span class="comment">/* 举例 */</span></span><br><span class="line"><span class="meta">#progma DATA_SECTION(SciaRegs,<span class="string">&quot;SciaRegsFile&quot;</span>)；</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">SCI_REGS</span> <span class="title">SciaRegs</span>;</span></span><br></pre></td></tr></table></figure><h3 id="寄存器">寄存器</h3><p>位域与结构：为了解决（1）不能对位变量的独立操作；（2）每一位都要写出具体数字；的问题。下面简述我们的解决方案</p><p><strong>（一）定义一个位结构（位域）——&gt; 联合结构（共同体）</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 以下文件应该放在.h文件（Head）下 */</span></span><br><span class="line"><span class="comment">/* 1. 定义位结构（位域） */</span></span><br><span class="line"><span class="comment">// 用于独立的对变量进行操作</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GPFDAT_BITS</span>&#123;</span></span><br><span class="line">    Uint16 GPIO0:<span class="number">1</span>; <span class="comment">// 第一个为最低位，:1表示长度为1bit</span></span><br><span class="line">    Uint16 GPIO1:<span class="number">1</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 2. 定义联合结构（共同体） */</span></span><br><span class="line"><span class="comment">// 由位结构struct+整型变量Uint共同组成，可以单独操作也可以整体操作</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">GPFDAT_REG</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GPFDAT_BITS</span> <span class="title">bit</span>;</span> <span class="comment">// 单独操作调用方法</span></span><br><span class="line">    Uint16 all; <span class="comment">// 整体操作调用方法</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>演示一下调用方法：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">GPFDAT_REG</span> <span class="title">GPFDAT</span>;</span></span><br><span class="line">GPFDAT.all = <span class="number">0x00ff</span>;</span><br><span class="line">GPFDAT.bit.GPIO15 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><strong>（二）定义一个包含一组联合的结构（结构体文件）</strong></p><p>说来复杂，其实也不难，就是把刚刚我们的一堆共同体union丢到一起，就是结构体文件了。一个结构体文件相当于一个班。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 以下文件应该放在.h文件（Head）下 */</span></span><br><span class="line"><span class="comment">/* 定义结构体（这个是最大的结构体了） */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GPIO_DATA_REGS</span>&#123;</span> <span class="comment">//结构体名字</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">GPADAT_REG</span> <span class="title">GPADAT</span>;</span> <span class="comment">// 类型（union GPADAT_REG）+ 变量（GPADAT）</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">GPFDAT_REG</span> <span class="title">GPFDAT</span>;</span></span><br><span class="line">    Uint16 rsvd1[<span class="number">4</span>]; <span class="comment">// 不严谨啊，位置不在这的，就是表示一下也可以有Uint16这种类型变量在的意思</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 定义变量 */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">GPIO_DATA_REGS</span> <span class="title">GpioDataRegs</span>;</span> <span class="comment">// 这个就是最后用的变量之一了！</span></span><br></pre></td></tr></table></figure><p><strong>（三）申明结构体变量实体，并指定其与section的关系（即分配空间）</strong></p><p>前半句话，就是上面（二）代码块中的最后一行，合并在一起写了</p><p>后半句话，参考CMD中的progma代码段，一般常用的都定义好了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 以下文件应该放在.c文件下 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus </span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> DATA_SECTION(<span class="string">&quot;GpioDataRegsFile&quot;</span>) </span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> DATA_SECTION(GpioDataRegs,<span class="string">&quot;GpioDataRegsFile&quot;</span>);</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">GPIO_DATA_REGS</span> <span class="title">GpioDataRegs</span>;</span></span><br></pre></td></tr></table></figure><p><strong>（四）在链接命令文件CMD中建立连接</strong></p><p>参考CMD中的第一个代码块</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MEMORY&#123;</span><br><span class="line">    PAGE <span class="number">1</span>:</span><br><span class="line">        GPIODAT : origin = <span class="number">0x0070E0</span>, length = <span class="number">0x000020</span></span><br><span class="line">        PIE_VECT: origin = <span class="number">0x000D00</span>, length = <span class="number">0x000100</span></span><br><span class="line">&#125;</span><br><span class="line">SECTIONS&#123;</span><br><span class="line">    PieVectTableFile : &gt; PIE_VECT,  PAGE = <span class="number">1</span></span><br><span class="line">    GpioDataRegsFile : &gt; GPIODAT ，PAGE = <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>（五）成功调用</strong></p><p>变量成为一个结构的成员，同时又有了自己的地址</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GpioDataRegs.GPFDAT.bit.GPIO11 = <span class="number">1</span>;</span><br><span class="line">GpioDataRegs.GPFDAT.all = <span class="number">0x1234</span>;</span><br><span class="line"><span class="comment">// 大结构体.共同体union.位域bit或整体all</span></span><br></pre></td></tr></table></figure><h2 id="串行外设接口spi">串行外设接口SPI</h2><table><colgroup><col style="width:4%"><col style="width:8%"><col style="width:22%"><col style="width:64%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>配置</td><td>SPICCR</td><td>SPI配置控制寄存器</td><td>第6位控制信号极性（上升/下降沿）<br>0-3位控制单个字符读取数量</td></tr><tr class="even"><td>控制</td><td>SPICTL</td><td>SPI工作控制寄存器</td><td>第2位网络模式控制（‘0’ - 从机；‘1’ - 主机）<br>第1位主从机发送使能TALK；第0位中断使能</td></tr><tr class="odd"><td>状态</td><td>SPISTS</td><td>SPI状态寄存器</td><td>第7位接收器溢出标志<br>第6位只读中断标志<strong>INT FLAG</strong>（完成数据发送/接收）<br>第5位发送缓冲器已满标志位<strong>FULL</strong></td></tr><tr class="even"><td>时钟</td><td>SPIBRR</td><td>SPI波特率寄存器</td><td>第0-6位控制波特率（<span class="math inline">\(Rate=\frac{LSPCLK}{SPIBRR+1}\)</span>）</td></tr><tr class="odd"><td>数据</td><td>SPIRXBUF</td><td>SPI串行接收缓存寄存器</td><td>接收后INT FLAG置1</td></tr><tr class="even"><td></td><td>SPITXBUF</td><td>SPI串行发送缓存寄存器</td><td>发送后TX BUF FULL被清除</td></tr><tr class="odd"><td></td><td>SPIDAT</td><td>SPI串行数据寄存器</td><td>略</td></tr></tbody></table><h2 id="事件管理器ev">事件管理器EV</h2><ul><li>以EVA的Timer1为例</li></ul><table><colgroup><col style="width:5%"><col style="width:7%"><col style="width:21%"><col style="width:65%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>控制</td><td>GPTCONA</td><td>全局控制寄存器A</td><td>.T1PIN：比较输出极性，01低，10高<br>.T1CMPOE：比较输出使能（1有效）<br>.TCMPOE：全局比较输出使能（1有效）</td></tr><tr class="even"><td></td><td>T1CON</td><td>定时器1控制寄存器</td><td>.TECMPR：定时器比较使能（1有效）<br>.TCLKS10：时钟源（00内部时钟）<br>.TENABLE：定时器使能（1有效）<br>.TPS：输入时钟预定标因子（分频：HSPCLK/2^n）<br>.TMODE10：计数模式（01连续增减，10连续增）</td></tr><tr class="odd"><td>计数</td><td>T1CNT</td><td>定时器1计数寄存器</td><td>略</td></tr><tr class="even"><td></td><td>T1PR</td><td>定时器1周期寄存器</td><td>略</td></tr><tr class="odd"><td></td><td>T1CMPR</td><td>定时器1比较寄存器</td><td>略</td></tr><tr class="even"><td>死区</td><td>DBTCONA</td><td>死区定时器控制寄存器</td><td>.DBTPS：死区定时器预定标因子（分频：T1时钟/2^n）<br>.EDBT1：死区定时器1使能（1有效）<br>.DBT：死区周期</td></tr><tr class="odd"><td>PWM波</td><td>CMPR1</td><td>比较寄存器1</td><td>略</td></tr></tbody></table><h2 id="数模转换器adc">数模转换器ADC</h2><ul><li>ADC的时钟分频：</li></ul><ol type="1"><li>准备：PCLKCR使能</li><li>外部晶振信号30MHz——PLLCR=0xA——SYSCLKOUT=150MHz</li><li>HISPCP=001（例）——HSPCLK=150/2MHz=75MHz</li><li>ADCTRL3.ADCCLKPS分频（2n）倍（n=0时不起作用）</li><li>ADCTRL1.CPS分频（m+1）倍</li></ol><table><colgroup><col style="width:3%"><col style="width:13%"><col style="width:25%"><col style="width:57%"></colgroup><thead><tr class="header"><th>从属</th><th>名称</th><th>描述</th><th>使用</th></tr></thead><tbody><tr class="odd"><td>控制</td><td>ADCTRL1</td><td>ADC控制寄存器1</td><td>.CPS：内核时钟预定标，用于分频<br>.CONT RUN：连续运行or启停模式（一般选0启停）<br>.SEQ CASC：SEQ级联or双序列</td></tr><tr class="even"><td></td><td>ADCTRL2</td><td>ADC控制寄存器2</td><td>.RST1：复位序列发生器<br>.SOC SEQ1：序列发生器1启动触发，主动写入/中断自动调用<br>.INT ENA SEQ1：中断使能<br>.INT MOD SEQ1：中断方式（每个/隔一个）<br>.EVA SOC SEQ1：事件管理器EVA允许触发使能<br>其余有关SEQ2的略，类似</td></tr><tr class="odd"><td></td><td>ADCTRL3</td><td>ADC控制寄存器3</td><td>.ADCBGRFDN：上电，一般写1，需要长延时<br>.ADCPWDN：上电，一般写1，需要长延时<br>.ADCCLKPS：时钟分频<br>.SMODE SEL：采样方式：顺序or并发</td></tr><tr class="even"><td>序列</td><td>MAXCONV</td><td>最大转换通道寄存器</td><td>进行（n+1）次转换</td></tr><tr class="odd"><td></td><td>ADCCHSELSEQ1-4</td><td>输入通道选择序列控制寄存器</td><td>见书p254，一个CHSELSEQ有4个CONV，一个CONV寄存一个输入</td></tr><tr class="even"><td>状态</td><td>ADCASEQSR</td><td>自动序列状态寄存器</td><td>看不懂</td></tr><tr class="odd"><td></td><td>ADCST</td><td>ADC状态和标志寄存器</td><td>.INT SEQx CLR：中断清除位，写1清除<br>.SEQx BSY：忙状态位，0表示空闲，只读<br>.INT SEQx：中断标志位，1表示有中断，只读</td></tr></tbody></table><h1 id="c语言代码">C语言代码</h1><h2 id="基本代码定义与框架">基本代码定义与框架</h2><h3 id="引脚定义实例">引脚定义实例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> <span class="string">&lt;引脚名&gt;</span> *((volatile unsigned int*) 引脚号);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PLLCR *((volatile unsigned int*) 0x7021);</span></span><br></pre></td></tr></table></figure><h3 id="控制时钟pll初始化">控制时钟PLL初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitPLL</span><span class="params">()</span>&#123;</span><br><span class="line">	EALLOW;</span><br><span class="line">	PLLCR=<span class="number">10</span>; <span class="comment">// 0~10, SYSCLK=外部晶振f*PLLCR/2</span></span><br><span class="line">	EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="看门狗初始化">看门狗初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">DisableDog</span><span class="params">()</span>&#123;</span><br><span class="line">	EALLOW;</span><br><span class="line">	WDCR = <span class="number">0x0068</span>; <span class="comment">// 禁止WatchDog, 0x0028开启</span></span><br><span class="line">	EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="外设时钟初始化">外设时钟初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitPeripheralClock</span><span class="params">()</span>&#123;</span><br><span class="line">	EALLOW;</span><br><span class="line">	EVAENCLK = <span class="number">1</span>;</span><br><span class="line">	EVBENCLK = <span class="number">1</span>;</span><br><span class="line">	SCIENCLKA = <span class="number">1</span>;</span><br><span class="line">	EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总初始化-initsysctrl">总初始化 InitSysCtrl</h3><h4 id="写法1">写法1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitSysCtrl</span><span class="params">()</span>&#123;</span><br><span class="line">	DisableDog();</span><br><span class="line">	InitPLL();</span><br><span class="line">	InitPeripheralClock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="写法2">写法2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitSysCtrl</span><span class="params">()</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">	<span class="comment">// DisableDog();</span></span><br><span class="line">	WDCR = <span class="number">0x0068</span>;</span><br><span class="line">	<span class="comment">// InitPLL();</span></span><br><span class="line">    PLLCR=(<span class="number">0</span>~<span class="number">10</span>);</span><br><span class="line">	<span class="comment">// InitPeripheralClock();</span></span><br><span class="line">    EVAENCLK = <span class="number">1</span>;</span><br><span class="line">	EVBENCLK = <span class="number">1</span>;</span><br><span class="line">	SCIENCLKA = <span class="number">1</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gpio初始化-initgpio">GPIO初始化 InitGpio</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitGpioF</span><span class="params">()</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GPFMUX=<span class="number">0x0000</span>; <span class="comment">// 也等于0x80FF等</span></span><br><span class="line">    GPXDIR=<span class="number">0xFF00</span>; <span class="comment">// 也等于3F00等</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cpu定时器初始化-initcputimer">CPU定时器初始化 InitCPUtimer</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0PRD *((volatile long int*)0x0C02;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TCR *((volatile unsigned int*)0x0C04;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TPR *((volatile unsigned int*)0x0C06;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TPRH *((volatile unsigned int*)0x0C07;</span></span><br><span class="line"><span class="comment">// SYSCLKIN = 30 MHz, PLLCR = 10, SYSCLKOUT = 150 MHz</span></span><br><span class="line"><span class="comment">// 要求变成1s的定时器，这里先除150[(149+1)*(0+1)]，再除10e6(999999+1)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitCPUtimer</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    TIMER0TPR = <span class="number">149</span>;</span><br><span class="line">    TIMER0TPRH = <span class="number">0</span>;</span><br><span class="line">    TIMER0PRD = <span class="number">999999</span>;</span><br><span class="line">    TIMER0TCR = <span class="number">0xf000</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="时钟延时函数">时钟延时函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 已经定义过InitCPUtimer</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> val)</span>&#123;</span><br><span class="line">    <span class="type">int</span> k;</span><br><span class="line">    EALLOW;</span><br><span class="line">    TIMER0PRD = val;</span><br><span class="line">    TIMER0TCR = <span class="number">0xf020</span>; <span class="comment">// 重新装载数据</span></span><br><span class="line">    <span class="keyword">do</span> &#123;k = TIMER0TCR&#125; <span class="keyword">while</span> ((k &amp; <span class="number">0x8000</span>) == <span class="number">0</span>);</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pie中断初始化-initpie">PIE中断初始化 InitPIE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设仅使用INT1.7，仅允许该中断通过</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIECTRL *((volatile unsigned int*)0x0CE0);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIEACK *((volatile unsigned int*)0x0CE1);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIEIER1 *((volatile unsigned int*)0x0CE2);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIEIFR1 *((volatile unsigned int*)0x0CE3);</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPIE</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    PIEIFR1 = <span class="number">0x0000</span>;</span><br><span class="line">    PIEIER1 = <span class="number">0x0040</span>; <span class="comment">// 使能</span></span><br><span class="line">    PIECTRL = <span class="number">0x1</span>; <span class="comment">// 使向量取自PIE向量表</span></span><br><span class="line">    PIEACK = <span class="number">0x1</span>; <span class="comment">// 清零，表示暂无中断</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="中断向量的申请">中断向量的申请</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 申明</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_m_n</span><span class="params">(<span class="type">void</span>)</span>; <span class="comment">// m=0~12, n=0~8</span></span><br><span class="line"><span class="comment">// 2.地址计算</span></span><br><span class="line">PIE_VECT_m_n = <span class="number">0x0D40</span> + ((m<span class="number">-1</span>)*<span class="number">8</span>+(n<span class="number">-1</span>))*<span class="number">2</span>; <span class="comment">// 起始地址为0x0D40，如INT1.7就是0x0D4C</span></span><br><span class="line"><span class="comment">// 3. 赋值</span></span><br><span class="line"><span class="keyword">typedef</span> interrupt <span class="title function_">void</span> <span class="params">(*PINT)</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">(*(PINT*) PIE_VECT_m_n) = &amp;INT_m_n</span><br></pre></td></tr></table></figure><h3 id="cpu中断初始化">CPU中断初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitCPU</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    <span class="comment">// 汇编语言</span></span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; and IFR,#00H&quot;</span>); <span class="comment">// IFR置0，表示此时无中断</span></span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; and IER,#01H&quot;</span>); <span class="comment">// IER置1，使能</span></span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; EINT&quot;</span>); <span class="comment">// 总闸使能，这个就是INTM</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="spi初始化">SPI初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitSpi</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPFMUX.all = <span class="number">0x000F</span>; <span class="comment">// SPI与GPIOF共用引脚</span></span><br><span class="line">    EDIS;</span><br><span class="line">    SpiaRegs.SPICCR.all = <span class="number">0x47</span>; <span class="comment">// 个人感觉0x07也行</span></span><br><span class="line">    SpiaRegs.SPICTL.all = <span class="number">0x06</span>; <span class="comment">// 主机模型 + 禁用中断</span></span><br><span class="line">    SpiaRegs.SPIBRR = <span class="number">0x7F</span>; <span class="comment">// 书上作0x1D，配置波特率</span></span><br><span class="line">    SpiaRegs.SPICCR.all = SpiaRegs.SPICCR.all | <span class="number">0x0080</span>; <span class="comment">// 退出复位的方式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="spi数据发送">SPI数据发送</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">SpiSent</span><span class="params">(<span class="type">int</span> k)</span>&#123;</span><br><span class="line">    SpiaRegs.SPITXBUF = k; <span class="comment">// 数据输入</span></span><br><span class="line">    <span class="keyword">while</span> (SpiaRegs.SPISTS.bit.INT_FLAG != <span class="number">1</span>) &#123;&#125; <span class="comment">// 确认数据发送完毕</span></span><br><span class="line">    SpiaRegs.SPIRXBUF = SpiaRegs.SPIRXBUF; <span class="comment">// 复位</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="点红灯函数">点红灯函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> redled = <span class="number">0xffff</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Out_redled</span><span class="params">(redled)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all |= <span class="number">0Xff00</span>;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">2</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled * <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">3</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">7</span>;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0X00ff</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="八段数码管循环">八段数码管循环</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Display</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioDataRegs.GPADAT.bit.GPIOA11 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="comment">// 依次输入8个数据，数码管自动往前移位</span></span><br><span class="line">        SpiaRegs.SPITXBUF= LEDCode[LEDReg[i]]; </span><br><span class="line">        <span class="keyword">while</span> (SpiaRegs.SPISTS.bit.INT_FLAG!= <span class="number">1</span>) &#123;&#125;;</span><br><span class="line">        SpiaRegs.SPIRXBUF= SpiaRegs.SPIRXBUF;</span><br><span class="line">    &#125;</span><br><span class="line">    GpioDataRegs.GPADAT.bit.GPIOA11 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="键盘的读取">键盘的读取</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> Keyin = <span class="number">0xffff</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Keyscan</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key1R , key2R; </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0x00FF</span>;</span><br><span class="line">    <span class="comment">/* KEYA - 低八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF8</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">    key1R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">30000</span>; i++) &#123;&#125;   <span class="comment">// 长延时消除抖动</span></span><br><span class="line">    <span class="keyword">if</span> (key1R != GpioDataRegs.GPBDAT.all) key1R=<span class="number">0xffff</span> ;</span><br><span class="line">    <span class="comment">/* KEYB - 高八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF9</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">    key2R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">30000</span>; i++) &#123;&#125;   <span class="comment">// 长延时消除抖动</span></span><br><span class="line">    <span class="keyword">if</span>(key2R != GpioDataRegs.GPBDAT.all) key2R=<span class="number">0xffff</span>;</span><br><span class="line">    <span class="comment">/* Add */</span></span><br><span class="line">    Keyin = key2R &amp; <span class="number">0xff00</span> + key1R / <span class="number">256</span>; </span><br><span class="line">	<span class="comment">// 例：key2R = 0xfbff, key1R = ffff, 则：Keyin = fbff, 同一时间不允许两个键同时按下 </span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="等待键盘输入">等待键盘输入</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">WaitKeyin</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> temp;</span><br><span class="line">    <span class="keyword">while</span> (Keyin == <span class="number">0xffff</span>) &#123;Keyscan();&#125; <span class="comment">// 等待直到键盘有输入</span></span><br><span class="line">    temp = Keyin;</span><br><span class="line">    <span class="keyword">while</span> (Keyin != <span class="number">0xffff</span>) &#123;Keyscan();&#125; <span class="comment">// 松开键盘时建立响应</span></span><br><span class="line">    <span class="keyword">switch</span> (temp)&#123;</span><br><span class="line">        <span class="keyword">case</span> K1: Keyin = <span class="number">1</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span> : Keyin = <span class="number">0x10</span>; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="键号判别功能转移">键号判别、功能转移</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// for (;;) &#123;asm(&quot; IDLE&quot;);&#125;</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;KeyFunction();&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">KeyFunction</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    WaitKeyin();</span><br><span class="line">    <span class="keyword">switch</span> (Keyin)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            	<span class="comment">// do something</span></span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通用定时器编程初始化">通用定时器编程初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">EVA_Timer1</span><span class="params">()</span>&#123;</span><br><span class="line">    EvaRegs.EXTCONA.bit.INDCOE= <span class="number">1</span>; <span class="comment">// 决定T1，T2是否关联</span></span><br><span class="line">    EvaRegs.GPTCONA.all= <span class="number">0x0012</span>; <span class="comment">// 4.5.6位说明T1，T2是否输出</span></span><br><span class="line">    EvaRegs.T1PR = <span class="number">0x003</span>; <span class="comment">// 峰值</span></span><br><span class="line">    EvaRegs.T1CMPR = <span class="number">0x0001</span>; <span class="comment">// Compare</span></span><br><span class="line">    EvaRegs.T1CNT = <span class="number">0x0000</span>; <span class="comment">// 计数器初始化</span></span><br><span class="line">    EvaRegs.T1CON.all = <span class="number">0x1742</span>; <span class="comment">// 确定运行方式，或0x0F42</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="设置pwm波周期波形">设置PWM波周期波形</h3><ol type="1"><li>准备：PCLKCR使能EVA时钟</li><li>晶振30MHz——PLLCR=10——SYSCLK=150MHz</li><li>HISPCP=001（例）——HSPCLK=150/2MHz=75MHz（见书p134）</li><li>T1CON.TPS10=n——T1CLK：HSPCLK/2^ n=75/2^n MHz</li><li>T1PR = T1CLK / 要求的时钟频率 - 1</li></ol><ul><li>T1PWM，T2PWM不带死区</li><li>PWM1-6带死区，12、34、56互补</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitEVA</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* 初始化设置 */</span></span><br><span class="line">    EvaRegs.T1CON.bit.TMODE = <span class="number">2</span>; <span class="comment">// 连续增</span></span><br><span class="line">    EvaRegs.T1CON.bit.TPS = <span class="number">1</span>; <span class="comment">// T1CLK = HSPCLK/2 = 37.5 MHz</span></span><br><span class="line">    EvaRegs.T1CON.bit.TENABLE = <span class="number">0</span>; <span class="comment">// 暂时禁止T1计数</span></span><br><span class="line">    EvaRegs.T1CON.bit.TCLKS10 = <span class="number">0</span>; <span class="comment">// 使用内部时钟T1CLK</span></span><br><span class="line">    EvaRegs.T1CON.bit.TECMPR = <span class="number">1</span>; <span class="comment">// 使能定时器比较操作</span></span><br><span class="line">    EvaRegs.GPTCONA.bit.TCMPOE = <span class="number">1</span>; <span class="comment">// T1和T2互不影响（书上代码写的是TCOMPOE?）</span></span><br><span class="line">    EvaRegs.GPTCONA.bit.T1PIN = <span class="number">1</span>; <span class="comment">//低电平有效</span></span><br><span class="line">    EvaRegs.COMCONA.bit.CENABLE = <span class="number">1</span>; <span class="comment">// 使能比较单元的比较操作</span></span><br><span class="line">    EvaRegs.COMCONA.bit.FCOMPOE = <span class="number">1</span>; <span class="comment">// 全比较输出</span></span><br><span class="line">    EvaRegs.COMCONA.bit.CLD = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/* 具体设置——T1PWM */</span></span><br><span class="line">    EvaRegs.T1PR = <span class="number">0x927B</span>; <span class="comment">// 1kHz，计算详见书p239</span></span><br><span class="line">    EvaRegs.T1CMPR = <span class="number">0x3A98</span>; <span class="comment">// 占空比40%</span></span><br><span class="line">    EvaRegs.T1CNT = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* 死区设置——PWM1-6 */</span></span><br><span class="line">    EvaRegs.DBTCONA.bit.DBT = <span class="number">10</span>; <span class="comment">// 周期</span></span><br><span class="line">    EvaRegs.DBTCONA.bit.EDBT1 = <span class="number">1</span>; <span class="comment">// 死区定时器1使能</span></span><br><span class="line">    EvaRegs.DBTCONA.bit.DBTPS = <span class="number">4</span>; <span class="comment">// 预标定因子——分频</span></span><br><span class="line">    EvaRegs.ACTRA.all = <span class="number">0x9999</span>;</span><br><span class="line">    EvaRegs.CMPR1 = <span class="number">0x3A98</span>; <span class="comment">// 占空比40%</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* 初始化 */</span></span><br><span class="line">    InitEVA();</span><br><span class="line">    EvaRegs.T1CON.bit.TENABLE = <span class="number">1</span>; <span class="comment">// 使能定时器1计数</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="adc上电">ADC上电</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">AdcPower</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCBGRFDN = <span class="number">0x3</span>; <span class="comment">// ADC带隙和参考电路加电</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++)&#123;&#125; <span class="comment">//至少5ms延时</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCPWDN = <span class="number">1</span>; <span class="comment">// ADC模拟电路加电</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">50000</span>;i++)&#123;&#125; <span class="comment">//至少20us延时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="adc初始化">ADC初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitAdc</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    AdcRegs.ADCTRL1.bit.CPS = <span class="number">1</span>; <span class="comment">// 3分频 —— 75MHz/3 = 25MHz</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.CONT_RUN = <span class="number">0</span>; <span class="comment">// 启停模式</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.SEQ_CASC = <span class="number">1</span>; <span class="comment">// 单序列发生器</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.ACQ_PS = <span class="number">0xf</span>; <span class="comment">// 采样窗口大小</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCCLKPS = <span class="number">2</span>; <span class="comment">// 4分频 —— 25MHz/4 = 6.25MHz</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.SMODE_SEL = <span class="number">0</span>; <span class="comment">// 顺序采样</span></span><br><span class="line">    AdcRegs.ADCMAXCONV.all = <span class="number">0x0</span>; <span class="comment">// 只采样1个通道，书上这里寄存器写错了</span></span><br><span class="line">    AdcRegs.ADCCHSELSEQ1.bit.CONV00 = <span class="number">0xF</span>; <span class="comment">// 本实验仅用到ADCINB7</span></span><br><span class="line">    <span class="comment">/* 书中还有下文，但是感觉应该都是控制中断，本实验不需要中断，因此不用初始化 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="adc调用示例">ADC调用示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">AdcFunction</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    AdcRegs.ADCTRL2.bit.SOC_SEQ1 = <span class="number">1</span>; <span class="comment">// 手动启动</span></span><br><span class="line">    <span class="keyword">while</span>(AdcRegs.ADCST.bit.SEQ1_BSY == <span class="number">1</span>)&#123;&#125; <span class="comment">// 等待转换完毕</span></span><br><span class="line">    <span class="type">int</span> AD1,AD2;</span><br><span class="line">    AD1 = AdcRegs.ADCRESULT0 &gt;&gt; <span class="number">4</span>; <span class="comment">// 数据寄存在高12位，右移四位</span></span><br><span class="line">    AD2 = (AD1<span class="number">-0x0</span>)*<span class="number">3</span>*<span class="number">1000</span> / <span class="number">0x0fff</span>; <span class="comment">// 0x0对应0,0x0fff对应3V，线性比例关系。</span></span><br><span class="line">    <span class="comment">//  *1000 用于取小数，可自由增删0的个数，以增减精度（因为是int）</span></span><br><span class="line">    <span class="comment">/* TODO */</span></span><br><span class="line">    AdcRegs.ADCTRL2.bit.RST_SEQ1 = <span class="number">1</span>; <span class="comment">// 复位序列发生器SEQ1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="键盘与红灯的冲突解决方案">键盘与红灯的冲突解决方案</h3><p>原因是两者都会调用GPB和GPE，且键盘需要一直进行监视（<code>Keyscan()</code>），不能把GPB放出来。</p><ol type="1"><li>选择将<code>Keyscan()</code>这个函数放到CPUTimer中，而不是在main的死循环里面调用。</li><li>将<code>Keyscan()</code>函数中的输出值放到全局变量中，并尽可能减小其时间，即删去防抖动的延时、减小反应时间延时。</li><li><code>WaitKeyin()</code>函数不再被允许调用<code>Keyscan()</code>，而是直接读取数值</li><li>在<code>Keyscan()</code>中的开头和结尾都要加上对GPB的控制</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> Keyin = <span class="number">0xffff</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Keyscan</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key1R , key2R; </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0x00FF</span>;</span><br><span class="line">    <span class="comment">/* KEYA - 低八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF8</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">    key1R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="comment">/* KEYB - 高八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF9</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">	key2R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="comment">/* Add */</span></span><br><span class="line">    Keyin = key2R &amp; <span class="number">0xff00</span> + key1R / <span class="number">256</span>; </span><br><span class="line">	GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0x00FF</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">WaitKeyin</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;<span class="keyword">asm</span>(<span class="string">&quot; IDLE&quot;</span>);&#125; <span class="keyword">while</span>(Keyin == <span class="number">0xffff</span>); <span class="comment">// 按下</span></span><br><span class="line">    temp = Keyin;</span><br><span class="line">    <span class="keyword">do</span> &#123;<span class="keyword">asm</span>(<span class="string">&quot; IDLE&quot;</span>);&#125; <span class="keyword">while</span>(Keyin != <span class="number">0xffff</span>); <span class="comment">// 松开</span></span><br><span class="line">    <span class="keyword">switch</span>(temp)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfffe</span>: Keyout = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">// 0</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> redled = <span class="number">0xffff</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Out_redled</span><span class="params">(redled)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all |= <span class="number">0Xff00</span>;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">2</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled * <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">3</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">7</span>;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0X00ff</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实例">实例</h2><h3 id="实例1-点灯">实例1 点灯</h3><ul><li>点亮六盏灯，利用GPIOF的8-13位输出。（高电平灭灯）</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GPFMUX *((volatile unsigned int*)0x70D4);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPFDIR *((volatile unsigned int*)0x70D5);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPFDAT *((volatile unsigned int*)0x70F4);</span></span><br><span class="line"><span class="type">int</span> delay_n <span class="number">30000</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitSysCtrl</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpioF</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Delay_Loop</span><span class="params">(<span class="type">int</span> n)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    InitSysCtrl();</span><br><span class="line">    InitGpioF();</span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        Delay_Loop(delay_n);</span><br><span class="line">        GPFDAT = <span class="number">0x5600</span> <span class="comment">// 0x56 = 01010110</span></span><br><span class="line">        Delay_Loop(delay_n);</span><br><span class="line">        GPFDAT = <span class="number">0x1200</span> <span class="comment">// 0x12 = 00010010</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例2-中断编程">实例2 中断编程</h3><ul><li>利用TIMER0中断，使GPIOF8闪烁，周期为3s，亮1s。</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> interrupt <span class="title function_">void</span><span class="params">(*PINT)</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 四个初始化</span></span><br><span class="line">    InitSysCtrl();</span><br><span class="line">    InitGpioF();</span><br><span class="line">    InitCPUtimer();</span><br><span class="line">    InitPIE();</span><br><span class="line">    <span class="comment">// 主程序</span></span><br><span class="line">    EALLOW;</span><br><span class="line">    *(PINT*)<span class="number">0x0D4C</span> = &amp;INT_1_7;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; and IFR,#00H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; and IER,#01H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot; EINT&quot;</span>);</span><br><span class="line">    LPMCR0 = <span class="number">0x0</span>; <span class="comment">// 定义低功耗方式为00，即IDLE</span></span><br><span class="line">    EDIS;</span><br><span class="line">    <span class="comment">// Else</span></span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot; IDLE&quot;</span>); <span class="comment">// 开始睡觉</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    k += <span class="number">1</span>; <span class="comment">// Global k</span></span><br><span class="line">    <span class="keyword">if</span> (k==<span class="number">3</span>)&#123;</span><br><span class="line">        k=<span class="number">0</span>;</span><br><span class="line">        GPFDAT = <span class="number">0xfeff</span>; <span class="comment">// 开</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        GPFDAT = <span class="number">0x0100</span>; <span class="comment">// 关</span></span><br><span class="line">    &#125;</span><br><span class="line">    PIEACK = <span class="number">0x1</span>; <span class="comment">// 表示响应过了（0的话会申请中断）</span></span><br><span class="line">    TIMER0TCR = <span class="number">0xf000</span>; <span class="comment">// 写1中断清除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例3-绿灯闪烁点红灯">实例3 绿灯闪烁+点红灯</h3><ul><li>GPIOE</li></ul><table><thead><tr class="header"><th>输入</th><th>效果</th></tr></thead><tbody><tr class="odd"><td>2</td><td>选择寄存器1，即GPBDAT与左边八盏红灯建立联系</td></tr><tr class="even"><td>3</td><td>选择寄存器2，即GPBDAT与右边八盏红灯建立联系</td></tr><tr class="odd"><td>7</td><td>产生一个下降沿，使寄存器（GPBDAT）发送数据</td></tr></tbody></table><ul><li>GPIOB</li></ul><p>输入数据的前八位控制红灯（初始化GPBDIR为0xFF00）</p><p>如<code>GPBDAT = 0xfeff</code>，且<code>GPEDAT = 2</code>，则左边第一盏红灯亮。（DAT最低位对应第一盏灯）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EALLOW asm(<span class="string">&quot; EALLOW&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIS   asm(<span class="string">&quot; EDIS&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PLLCR   *((volatile unsigned int *) 0x7021)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCLKCR  *((volatile unsigned int *) 0x701C)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HISPCP  *((volatile unsigned int *) 0x701A)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOSPCP  *((volatile unsigned int *) 0x701B)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WDCR    *((volatile unsigned int *) 0x7029)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCSR    *((volatile unsigned int *) 0x7022)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LPMCR0  *((volatile unsigned int *) 0x701E)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPFMUX  *((volatile unsigned int *) 0x70D4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPFDIR  *((volatile unsigned int *) 0x70D5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPFDAT  *((volatile unsigned int *) 0x70F4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPBMUX  *((volatile unsigned int *) 0x70C4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPBDIR  *((volatile unsigned int *) 0x70C5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPBDAT  *((volatile unsigned int *) 0x70E4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPEMUX  *((volatile unsigned int *) 0x70D0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPEDIR  *((volatile unsigned int *) 0x70D1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPEDAT  *((volatile unsigned int *) 0x70F0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0PRD   *((volatile unsigned long int *) 0x0C02)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TCR   *((volatile unsigned int *) 0x0C04)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TPR   *((volatile unsigned int *) 0x0C06)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER0TPRH  *((volatile unsigned int *) 0x0C07)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  PIECTRL    *((volatile unsigned int *) 0x0CE0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  PIEACK     *((volatile unsigned int *) 0x0CE1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  PIEIER1    *((volatile unsigned int *) 0x0CE2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  PIEIFR1    *((volatile unsigned int *) 0x0CE3)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPll</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   <span class="type">int</span> i;</span><br><span class="line">    EALLOW;</span><br><span class="line">    PLLCR = <span class="number">10</span>;<span class="comment">//SYSCLK = 外部振荡频率（30M） * PLLCR /2</span></span><br><span class="line">    EDIS;</span><br><span class="line">    <span class="keyword">for</span>(i= <span class="number">0</span>; i&lt; ( (<span class="number">131072</span>/<span class="number">2</span>)/<span class="number">12</span> ); i++) &#123;;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPeripheralClocks</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    HISPCP = <span class="number">1</span>;  <span class="comment">// HISPCLK= SYSCLK * HISPCP /2</span></span><br><span class="line">    LOSPCP = <span class="number">2</span>;  <span class="comment">// LOSPCLK= SYSCLK * LOSPCP /2</span></span><br><span class="line">    PCLKCR = <span class="number">0x909</span>;<span class="comment">// 开启部分外设</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">DisableDog</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    WDCR = <span class="number">0x0068</span>; <span class="comment">//关闭看门狗；；</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitSysCtrl</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    DisableDog();</span><br><span class="line">    InitPll();</span><br><span class="line">    InitPeripheralClocks();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpiof</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GPFMUX =<span class="number">0x0000</span>;</span><br><span class="line">    GPFDIR =<span class="number">0xFF00</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpiob</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GPBMUX =<span class="number">0x0000</span>;</span><br><span class="line">    GPBDIR =<span class="number">0xFF00</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpioe</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GPEMUX =<span class="number">0x0</span>;</span><br><span class="line">    GPEDIR =<span class="number">0x7</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitCputimer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    TIMER0TPR=<span class="number">149</span>;</span><br><span class="line">    TIMER0TPRH=<span class="number">0</span>;</span><br><span class="line">    TIMER0PRD=<span class="number">999</span>;<span class="comment">//周期为0.001s，即1ms </span></span><br><span class="line">    TIMER0TCR=<span class="number">0xf000</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPIE</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    PIEIFR1=<span class="number">0x0000</span>;</span><br><span class="line">    PIEIER1=<span class="number">0x0040</span>;</span><br><span class="line">    PIECTRL=<span class="number">0x1</span>;</span><br><span class="line">    PIEACK =<span class="number">0x1</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> interrupt <span class="title function_">void</span><span class="params">(*PINT)</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> a, b, c, d, e, f;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   InitSysCtrl();</span><br><span class="line">    InitGpiof();</span><br><span class="line">    InitGpiob();</span><br><span class="line">    InitGpioe();</span><br><span class="line">    InitCputimer();</span><br><span class="line">    InitPIE();</span><br><span class="line">    EALLOW;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点红灯</span></span><br><span class="line"></span><br><span class="line">    GPEDAT = <span class="number">2</span>;      <span class="comment">//选第一组</span></span><br><span class="line">    GPBDAT = <span class="number">0xFDFF</span>; <span class="comment">//第二盏灯亮</span></span><br><span class="line"><span class="comment">//    for(i = 0;i&lt;100;i++)&#123;&#125;</span></span><br><span class="line">    GPEDAT = <span class="number">7</span>;      <span class="comment">//使产生一个下降沿</span></span><br><span class="line"></span><br><span class="line">    GPEDAT = <span class="number">3</span>;      <span class="comment">//选第二组</span></span><br><span class="line">    GPBDAT = <span class="number">0x7FFF</span>; <span class="comment">//第一盏灯亮</span></span><br><span class="line"><span class="comment">//    for(i = 0;i&lt;100;i++)&#123;&#125;</span></span><br><span class="line">    GPEDAT = <span class="number">7</span>;      <span class="comment">//使产生一个下降沿</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    * (PINT *) <span class="number">0x0D4C</span> = &amp; INT_1_7;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  and IFR,#00H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  or  IER,#01H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  EINT&quot;</span>);</span><br><span class="line">    LPMCR0=<span class="number">0x0</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">    a = <span class="number">0</span>, b = <span class="number">0</span>, c = <span class="number">0</span>, d = <span class="number">0</span>, e = <span class="number">0</span>, f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;<span class="keyword">asm</span>(<span class="string">&quot; IDLE&quot;</span>);&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//第一盏灯</span></span><br><span class="line">    a+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">500</span>)&#123;</span><br><span class="line">        GPFDAT=GPFDAT&amp;<span class="number">0xFEFF</span>;<span class="comment">//变亮</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">2000</span>)&#123;</span><br><span class="line">        a = <span class="number">0</span>;</span><br><span class="line">        GPFDAT=GPFDAT|<span class="number">0x0100</span>;<span class="comment">//变暗</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二盏灯</span></span><br><span class="line">    b+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">300</span>)&#123;</span><br><span class="line">        GPFDAT=GPFDAT&amp;<span class="number">0xFDFF</span>;<span class="comment">//变亮</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">1000</span>)&#123;</span><br><span class="line">        b = <span class="number">0</span>;</span><br><span class="line">        GPFDAT=GPFDAT|<span class="number">0x0200</span>;<span class="comment">//变暗</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第三盏灯</span></span><br><span class="line">    c+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(c == <span class="number">100</span>)&#123;</span><br><span class="line">        GPFDAT=GPFDAT&amp;<span class="number">0xFBFF</span>;<span class="comment">//变亮</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(c == <span class="number">200</span>)&#123;</span><br><span class="line">        c = <span class="number">0</span>;</span><br><span class="line">        GPFDAT=GPFDAT|<span class="number">0x0400</span>;<span class="comment">//变暗</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第四盏灯</span></span><br><span class="line">    d+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(d == <span class="number">10</span>)&#123;</span><br><span class="line">        GPFDAT=GPFDAT&amp;<span class="number">0xF7FF</span>;<span class="comment">//变亮</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(d == <span class="number">20</span>)&#123;</span><br><span class="line">        d = <span class="number">0</span>;</span><br><span class="line">        GPFDAT=GPFDAT|<span class="number">0x0800</span>;<span class="comment">//变暗</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第五盏灯</span></span><br><span class="line">    e+=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(e == <span class="number">9</span>)&#123;</span><br><span class="line">        GPFDAT=GPFDAT&amp;<span class="number">0xEFFF</span>;<span class="comment">//变亮</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(e == <span class="number">10</span>)&#123;</span><br><span class="line">        e = <span class="number">0</span>;</span><br><span class="line">        GPFDAT=GPFDAT|<span class="number">0x1000</span>;<span class="comment">//变暗</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第六盏灯</span></span><br><span class="line">    GPFDAT=GPFDAT|<span class="number">0x2000</span>;</span><br><span class="line">    </span><br><span class="line">    PIEACK=<span class="number">0x1</span>;</span><br><span class="line">    TIMER0TCR=<span class="number">0xf000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例4-键盘响应时钟ad转换">实例4 键盘响应+时钟+AD转换</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DSP281x_Device.h&quot;</span>     <span class="comment">// DSP281x头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DSP281x_GlobalPrototypes.h&quot;</span><span class="comment">// Prototypes for global functions within the  .c files.</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Init */</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpiof</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GpioMuxRegs.GPFMUX.all =<span class="number">0x0000</span>;</span><br><span class="line">    GpioMuxRegs.GPFDIR.all =<span class="number">0xFF00</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpioe</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GpioMuxRegs.GPEMUX.all =<span class="number">0x0</span>;</span><br><span class="line">    GpioMuxRegs.GPEDIR.all =<span class="number">0x7</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpiob</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GpioMuxRegs.GPBMUX.all =<span class="number">0x0000</span>;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all =<span class="number">0xFF00</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpioa</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    GpioMuxRegs.GPAMUX.all =<span class="number">0x0000</span>;</span><br><span class="line">    GpioMuxRegs.GPADIR.all =<span class="number">0xFF00</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitCputimer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    CpuTimer0Regs.TPR.all = <span class="number">149</span>;</span><br><span class="line">    CpuTimer0Regs.TPRH.all= <span class="number">0</span>;</span><br><span class="line">    CpuTimer0Regs.PRD.all = <span class="number">9999</span>; <span class="comment">// 10ms一个timer0中断</span></span><br><span class="line">    CpuTimer0Regs.TCR.all =<span class="number">0xf000</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitSpi</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPFMUX.all = <span class="number">0x000F</span>; <span class="comment">// SPI与GPIOF共用引脚</span></span><br><span class="line">    EDIS;</span><br><span class="line">    SpiaRegs.SPICCR.all = <span class="number">0x47</span>; <span class="comment">// 个人感觉0x07也行？ </span></span><br><span class="line">    SpiaRegs.SPICTL.all = <span class="number">0x06</span>; <span class="comment">// 主机模型 + 禁用中断</span></span><br><span class="line">    SpiaRegs.SPIBRR = <span class="number">0x7F</span>;</span><br><span class="line">    SpiaRegs.SPICCR.all = SpiaRegs.SPICCR.all | <span class="number">0x0080</span>; <span class="comment">// 退出复位的方式</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//typedef interrupt void(*PINT)(void);</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPIE</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   EALLOW;</span><br><span class="line">    PieCtrlRegs.PIEIFR1.all=<span class="number">0x0000</span>;</span><br><span class="line">    PieCtrlRegs.PIEIER1.all=<span class="number">0x0040</span>;</span><br><span class="line">    PieCtrlRegs.PIECRTL.bit.ENPIE=<span class="number">0x1</span>;</span><br><span class="line">    PieCtrlRegs.PIEACK.all =<span class="number">0x1</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AdcPower</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCBGRFDN = <span class="number">0x3</span>; <span class="comment">// ADC带隙和参考电路加电</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;&#125; <span class="comment">//至少5ms延时</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCPWDN = <span class="number">1</span>; <span class="comment">// ADC模拟电路加电</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5000</span>;i++)&#123;&#125; <span class="comment">//至少20us延时</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitAdc</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 这里跟老师的有点不太一样，改了分配，最终6.25MHz快了2倍</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.CPS = <span class="number">2</span>; <span class="comment">// 3分频 —— 75MHz/3 = 25MHz</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.CONT_RUN = <span class="number">0</span>; <span class="comment">// 启停模式</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.SEQ_CASC = <span class="number">0</span>; <span class="comment">// 单序列发生器</span></span><br><span class="line">    AdcRegs.ADCTRL1.bit.ACQ_PS = <span class="number">0xf</span>; <span class="comment">// 采样窗口大小</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.ADCCLKPS = <span class="number">2</span>; <span class="comment">// 4分频 —— 25MHz/4 = 6.25MHz</span></span><br><span class="line">    AdcRegs.ADCTRL3.bit.SMODE_SEL = <span class="number">0</span>; <span class="comment">// 顺序采样</span></span><br><span class="line">    AdcRegs.ADCMAXCONV.all = <span class="number">0x0</span>; <span class="comment">// 只采样1个通道</span></span><br><span class="line">    AdcRegs.ADCCHSELSEQ1.bit.CONV00 = <span class="number">0xF</span>; <span class="comment">// 本实验仅用到ADCINB7</span></span><br><span class="line">    <span class="comment">/* 书中还有下文，但是感觉应该都是控制中断，本实验不需要中断，因此不用初始化 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Functions */</span></span><br><span class="line"><span class="type">int</span> sec=<span class="number">0</span>,min=<span class="number">0</span>,hour=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> LEDReg[<span class="number">8</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span>  <span class="type">int</span> LEDCode[<span class="number">30</span>]=&#123;\</span><br><span class="line"><span class="comment">// 0      1      2     3      4      5       6      7      8      9</span></span><br><span class="line"><span class="number">0xc000</span>,<span class="number">0xf900</span>,<span class="number">0xA400</span>,<span class="number">0xB000</span>,<span class="number">0x9900</span>,<span class="number">0x9200</span>,<span class="number">0x8200</span>,<span class="number">0xF800</span>,<span class="number">0x8000</span>,<span class="number">0x9000</span>,\</span><br><span class="line"><span class="comment">// A      b     C      d      E      F       P      -      c      空 </span></span><br><span class="line"><span class="number">0x8800</span>,<span class="number">0x8300</span>,<span class="number">0xc600</span>,<span class="number">0xa100</span>,<span class="number">0x8600</span>,<span class="number">0x8e00</span>,<span class="number">0x8c00</span>,<span class="number">0xbf00</span>,<span class="number">0xa700</span>,<span class="number">0xff00</span>,\</span><br><span class="line"><span class="comment">// 0.     1.     2.    3.     4.     5.      6.     7.     8.     9.</span></span><br><span class="line"><span class="number">0x4000</span>,<span class="number">0x7900</span>,<span class="number">0x2400</span>,<span class="number">0x3000</span>,<span class="number">0x1900</span>,<span class="number">0x1200</span>,<span class="number">0x0200</span>,<span class="number">0x7800</span>,<span class="number">0x0000</span>,<span class="number">0x1000</span>&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Display</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioDataRegs.GPADAT.bit.GPIOA11 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="comment">// 依次输入8个数据，数码管自动往前移位</span></span><br><span class="line">        SpiaRegs.SPITXBUF= LEDCode[LEDReg[i]]; </span><br><span class="line">        <span class="keyword">while</span> (SpiaRegs.SPISTS.bit.INT_FLAG!= <span class="number">1</span>) &#123;&#125;;</span><br><span class="line">        SpiaRegs.SPIRXBUF= SpiaRegs.SPIRXBUF;</span><br><span class="line">    &#125;</span><br><span class="line">    GpioDataRegs.GPADAT.bit.GPIOA11 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> redled  = <span class="number">0x0000</span>;<span class="comment">//低八位是左边，从低到高是从左到右；高八位是右边，从高到低是从右到左</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Out_redled</span> <span class="params">(redled)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all |= <span class="number">0XFF00</span>;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">2</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled * <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">3</span>;</span><br><span class="line">    GpioDataRegs.GPBDAT.all = redled;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all = <span class="number">7</span>;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0X00FF</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> Keyin = <span class="number">0xffff</span>;</span><br><span class="line"><span class="type">int</span> Keyout = <span class="number">16</span>; <span class="comment">// 0x10</span></span><br><span class="line"><span class="type">int</span> Flag_Stop = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> flag_AD = <span class="number">0</span>; <span class="comment">// 1-AD转换，0-时钟</span></span><br><span class="line"><span class="type">int</span> temp[<span class="number">6</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> AD[<span class="number">4</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> ten_ms = <span class="number">0</span>;<span class="comment">//10ms计数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Keyscan</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key1R , key2R; </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPBDIR.all &amp;= <span class="number">0x00FF</span>;</span><br><span class="line">    <span class="comment">/* KEYA - 低八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF8</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">    key1R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">30000</span>; i++) &#123;&#125;   <span class="comment">// 长延时消除抖动</span></span><br><span class="line">    <span class="keyword">if</span> (key1R != GpioDataRegs.GPBDAT.all) key1R=<span class="number">0xffff</span> ;</span><br><span class="line">    <span class="comment">/* KEYB - 高八位 */</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all  = <span class="number">0xFFF9</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;&#125; <span class="comment">//短延时</span></span><br><span class="line">    key2R = GpioDataRegs.GPBDAT.all;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">30000</span>; i++) &#123;&#125;   <span class="comment">// 长延时消除抖动</span></span><br><span class="line">    <span class="keyword">if</span>(key2R != GpioDataRegs.GPBDAT.all) key2R=<span class="number">0xffff</span>;</span><br><span class="line">    <span class="comment">/* Add */</span></span><br><span class="line">    Keyin = key2R &amp; <span class="number">0xff00</span> + key1R / <span class="number">256</span>; </span><br><span class="line">    <span class="comment">// 例：key2R = 0xfbff, key1R = ffff, 则：Keyin = fbff</span></span><br><span class="line">    <span class="comment">// 同一时间不允许两个键同时按下</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">WaitKeyin</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> temp;</span><br><span class="line">    <span class="keyword">while</span> (Keyin == <span class="number">0xffff</span>) &#123;Keyscan();&#125; <span class="comment">// 等待直到键盘有输入</span></span><br><span class="line">    temp = Keyin;</span><br><span class="line">    <span class="keyword">while</span> (Keyin != <span class="number">0xffff</span>) &#123;Keyscan();&#125; <span class="comment">// 松开键盘时建立响应</span></span><br><span class="line">    <span class="keyword">switch</span> (temp)&#123;</span><br><span class="line">        <span class="comment">// 低八位 - key1R</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfffe</span>: Keyout = <span class="number">0</span>; <span class="keyword">break</span>; <span class="comment">// 0</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfffd</span>: Keyout = <span class="number">1</span>; <span class="keyword">break</span>; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfffb</span>: Keyout = <span class="number">2</span>; <span class="keyword">break</span>; <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfff7</span>: Keyout = <span class="number">3</span>; <span class="keyword">break</span>; <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xffef</span>: Keyout = <span class="number">4</span>; <span class="keyword">break</span>; <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xffdf</span>: Keyout = <span class="number">5</span>; <span class="keyword">break</span>; <span class="comment">// 5</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xffbf</span>: Keyout = <span class="number">6</span>; <span class="keyword">break</span>; <span class="comment">// 6</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xff7f</span>: Keyout = <span class="number">7</span>; <span class="keyword">break</span>; <span class="comment">// 7</span></span><br><span class="line">        <span class="comment">// 高八位 - key2R</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfeff</span>: Keyout = <span class="number">8</span>; <span class="keyword">break</span>; <span class="comment">// 8</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfdff</span>: Keyout = <span class="number">9</span>; <span class="keyword">break</span>; <span class="comment">// 9</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xfbff</span>: Keyout = <span class="number">10</span>; <span class="keyword">break</span>; <span class="comment">// A</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xf7ff</span>: Keyout = <span class="number">11</span>; <span class="keyword">break</span>; <span class="comment">// B</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xefff</span>: Keyout = <span class="number">12</span>; <span class="keyword">break</span>; <span class="comment">// C</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xdfff</span>: Keyout = <span class="number">13</span>; <span class="keyword">break</span>; <span class="comment">// D</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xbfff</span>: Keyout = <span class="number">14</span>; <span class="keyword">break</span>; <span class="comment">// E</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x7fff</span>: Keyout = <span class="number">15</span>; <span class="keyword">break</span>; <span class="comment">// F</span></span><br><span class="line">        <span class="keyword">default</span> : Keyout = <span class="number">0x10</span>; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">TimerModify</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">6</span>)&#123;</span><br><span class="line">        WaitKeyin();</span><br><span class="line">        <span class="keyword">switch</span> (Keyout)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: temp[i++] = <span class="number">0</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: temp[i++] = <span class="number">1</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: temp[i++] = <span class="number">2</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: temp[i++] = <span class="number">3</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: temp[i++] = <span class="number">4</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: temp[i++] = <span class="number">5</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: temp[i++] = <span class="number">6</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: temp[i++] = <span class="number">7</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>: temp[i++] = <span class="number">8</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>: temp[i++] = <span class="number">9</span>; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;<span class="number">6</span>;temp[j++]=<span class="number">0</span>)&#123;&#125;</span><br><span class="line">                i = <span class="number">6</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!flag)&#123;</span><br><span class="line">        hour = temp[<span class="number">0</span>]*<span class="number">10</span>+temp[<span class="number">1</span>];</span><br><span class="line">        min = temp[<span class="number">2</span>]*<span class="number">10</span>+temp[<span class="number">3</span>];</span><br><span class="line">        sec = temp[<span class="number">4</span>]*<span class="number">10</span>+temp[<span class="number">5</span>];</span><br><span class="line">        <span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;<span class="number">6</span>;temp[j++]=<span class="number">0</span>)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">LED_Filling</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    LEDReg[<span class="number">0</span>] = hour / <span class="number">10</span>; LEDReg[<span class="number">1</span>] = hour % <span class="number">10</span>; <span class="comment">// hour</span></span><br><span class="line">    LEDReg[<span class="number">3</span>] = min / <span class="number">10</span>; LEDReg[<span class="number">4</span>] = min % <span class="number">10</span>; <span class="comment">// min</span></span><br><span class="line">    LEDReg[<span class="number">6</span>] = sec / <span class="number">10</span>; LEDReg[<span class="number">7</span>] = sec % <span class="number">10</span>; <span class="comment">// sec</span></span><br><span class="line">    LEDReg[<span class="number">2</span>] = <span class="number">17</span>; LEDReg[<span class="number">5</span>] = <span class="number">17</span>; <span class="comment">// 分隔符:-</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AdcFunction</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* Read */</span></span><br><span class="line">    <span class="keyword">while</span>(AdcRegs.ADCST.bit.SEQ1_BSY == <span class="number">1</span>)&#123;&#125; <span class="comment">// 等待转换完毕</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> AD1,AD2,i;</span><br><span class="line">    AD1 = AdcRegs.ADCRESULT0 &gt;&gt; <span class="number">4</span>; <span class="comment">// 数据寄存在高12位，右移四位</span></span><br><span class="line">    AD2 = (AD1)*<span class="number">3</span>*<span class="number">1000</span> / <span class="number">0x0fff</span>; <span class="comment">// 0x0对应0,0x0fff对应3V，线性比例关系。</span></span><br><span class="line">    <span class="comment">//  *1000 用于取小数，可自由增删0的个数，以增减精度（因为是int）</span></span><br><span class="line">    AD[<span class="number">0</span>] = AD2 / <span class="number">1000</span>;</span><br><span class="line">    AD[<span class="number">1</span>] = (AD2 % <span class="number">1000</span>) / <span class="number">100</span>;</span><br><span class="line">    AD[<span class="number">2</span>] = (AD2 % <span class="number">100</span>) / <span class="number">10</span>;</span><br><span class="line">    AD[<span class="number">3</span>] = (AD2 % <span class="number">10</span>);</span><br><span class="line">    AdcRegs.ADCTRL2.bit.RST_SEQ1 = <span class="number">1</span>; <span class="comment">// 复位序列发生器SEQ1</span></span><br><span class="line">    AdcRegs.ADCTRL2.bit.SOC_SEQ1 = <span class="number">1</span>; <span class="comment">// 手动启动</span></span><br><span class="line">    <span class="comment">/* Led Filling */</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++) LEDReg[i+<span class="number">5</span>] = AD[i+<span class="number">1</span>];</span><br><span class="line">    LEDReg[<span class="number">4</span>] = AD[<span class="number">0</span>] + <span class="number">20</span>; <span class="comment">// 带小数点</span></span><br><span class="line">    LEDReg[<span class="number">0</span>] = <span class="number">10</span>; LEDReg[<span class="number">1</span>] = <span class="number">13</span>; LEDReg[<span class="number">2</span>] = <span class="number">18</span>; LEDReg[<span class="number">3</span>] = <span class="number">17</span>; <span class="comment">// 标识符：Adc-</span></span><br><span class="line">    <span class="comment">//LEDReg[7] = 19;</span></span><br><span class="line">    <span class="type">int</span> offset = AD2 / <span class="number">500</span>;</span><br><span class="line">    GpioDataRegs.GPFDAT.all = (<span class="number">0xff00</span> &lt;&lt; offset) % <span class="number">0x10000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">KeyFunction</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    WaitKeyin();</span><br><span class="line">    <span class="keyword">switch</span> (Keyout)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(++sec &gt;=<span class="number">60</span>) sec = <span class="number">0</span>; <span class="comment">//秒+1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(--sec &lt;<span class="number">0</span>) sec = <span class="number">59</span>; <span class="comment">//秒-1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(++min &gt;=<span class="number">60</span>) min = <span class="number">0</span>; <span class="comment">//分+1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(--min &lt;<span class="number">0</span>) min = <span class="number">59</span>; <span class="comment">//分-1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(++hour &gt;=<span class="number">24</span>) hour = <span class="number">0</span>; <span class="comment">//时+1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: &#123;</span><br><span class="line">            <span class="keyword">if</span>(--hour &lt;<span class="number">0</span>) hour = <span class="number">23</span>; <span class="comment">//时-1</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: &#123;</span><br><span class="line">            Flag_Stop = <span class="number">1</span>;      <span class="comment">//暂停</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>: &#123;</span><br><span class="line">            Flag_Stop = <span class="number">0</span>;      <span class="comment">//启动</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line">            sec=<span class="number">0</span>,min=<span class="number">0</span>,hour=<span class="number">0</span>; <span class="comment">//清零重启</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:&#123; <span class="comment">// A</span></span><br><span class="line">            flag_AD = !flag_AD; <span class="comment">// AD与时钟的转换</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:&#123; <span class="comment">// B</span></span><br><span class="line">            flag_AD = <span class="number">0</span>; <span class="comment">// AD与时钟的转换</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:&#123; <span class="comment">// F</span></span><br><span class="line">            TimerModify(); <span class="comment">// 自由修改</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* main */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    InitSysCtrl();</span><br><span class="line">    AdcPower();</span><br><span class="line">    InitGpiof();</span><br><span class="line">    InitGpiob();</span><br><span class="line">    InitGpioe();</span><br><span class="line">    InitGpioa();</span><br><span class="line">    InitCputimer();</span><br><span class="line">    InitPIE();</span><br><span class="line">    InitSpi();</span><br><span class="line">    InitAdc();</span><br><span class="line">    EALLOW;</span><br><span class="line">    PieVectTable.TINT0 = &amp; INT_1_7;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  and IFR,#00H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  or  IER,#01H&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;  EINT&quot;</span>);</span><br><span class="line">    EDIS;</span><br><span class="line">    Out_redled (redled); <span class="comment">// 全亮</span></span><br><span class="line">    <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">        KeyFunction();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_1_7</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* time add */</span></span><br><span class="line">    <span class="keyword">if</span> (flag_AD == <span class="number">0</span>)&#123; <span class="comment">// 时钟</span></span><br><span class="line">        <span class="keyword">if</span>(Flag_Stop == <span class="number">0</span> &amp;&amp; ++ten_ms == <span class="number">100</span>)&#123; <span class="comment">// 不暂停</span></span><br><span class="line">            ten_ms = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/* time add */</span></span><br><span class="line">            sec ++;</span><br><span class="line">            <span class="keyword">if</span> (sec == <span class="number">60</span>)&#123;</span><br><span class="line">                sec = <span class="number">0</span>;</span><br><span class="line">                min ++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">60</span>)&#123;</span><br><span class="line">                min = <span class="number">0</span>;</span><br><span class="line">                hour ++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (hour == <span class="number">24</span>)&#123;</span><br><span class="line">                hour = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* LEDReg filling */</span></span><br><span class="line">            LED_Filling();</span><br><span class="line">            Display();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// AD</span></span><br><span class="line">        AdcFunction();</span><br><span class="line">        Display();</span><br><span class="line">    &#125;</span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">0x1</span>;</span><br><span class="line">    CpuTimer0Regs.TCR.all = <span class="number">0xf000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例5-跑马灯正弦亮度变化">实例5 跑马灯——正弦亮度变化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DSP281x_Device.h&quot;</span>     <span class="comment">// DSP281x头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DSP281x_GlobalPrototypes.h&quot;</span><span class="comment">// Prototypes for global functions within the  .c files.</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Parameters */</span></span><br><span class="line"><span class="type">int</span> redled  = <span class="number">0xffff</span>; <span class="comment">//低八位是左边，从低到高是从左到右；高八位是右边，从高到低是从右到左</span></span><br><span class="line"><span class="type">int</span> times = <span class="number">0</span>; <span class="comment">// 20ms改变一次比较值</span></span><br><span class="line"><span class="type">int</span> index = <span class="number">0</span>; <span class="comment">// 2s周期内一共100个比较值,16等分则index += 100/16</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> T_Period = <span class="number">587</span>; <span class="comment">// EvaRegs.T1PR+1</span></span><br><span class="line"><span class="type">int</span> led_tab[<span class="number">100</span>]=&#123;</span><br><span class="line"><span class="number">587</span>,<span class="number">585</span>,<span class="number">583</span>,<span class="number">580</span>,<span class="number">576</span>,<span class="number">571</span>,<span class="number">565</span>,<span class="number">558</span>,<span class="number">549</span>,<span class="number">540</span>,</span><br><span class="line"><span class="number">530</span>,<span class="number">518</span>,<span class="number">506</span>,<span class="number">493</span>,<span class="number">479</span>,<span class="number">465</span>,<span class="number">449</span>,<span class="number">434</span>,<span class="number">417</span>,<span class="number">400</span>,</span><br><span class="line"><span class="number">383</span>,<span class="number">365</span>,<span class="number">347</span>,<span class="number">329</span>,<span class="number">311</span>,<span class="number">293</span>,<span class="number">274</span>,<span class="number">256</span>,<span class="number">238</span>,<span class="number">220</span>,</span><br><span class="line"><span class="number">202</span>,<span class="number">185</span>,<span class="number">168</span>,<span class="number">151</span>,<span class="number">136</span>,<span class="number">120</span>,<span class="number">106</span>,<span class="number">92</span> ,<span class="number">79</span> ,<span class="number">67</span> ,</span><br><span class="line"><span class="number">55</span> ,<span class="number">45</span> ,<span class="number">36</span> ,<span class="number">27</span> ,<span class="number">20</span> ,<span class="number">14</span> ,<span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">9</span>  ,</span><br><span class="line"><span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">9</span>  ,<span class="number">14</span> ,<span class="number">20</span> ,<span class="number">27</span> ,<span class="number">36</span> ,<span class="number">45</span> ,</span><br><span class="line"><span class="number">55</span> ,<span class="number">67</span> ,<span class="number">79</span> ,<span class="number">92</span> ,<span class="number">106</span>,<span class="number">120</span>,<span class="number">136</span>,<span class="number">151</span>,<span class="number">168</span>,<span class="number">185</span>,</span><br><span class="line"><span class="number">202</span>,<span class="number">220</span>,<span class="number">238</span>,<span class="number">256</span>,<span class="number">274</span>,<span class="number">292</span>,<span class="number">311</span>,<span class="number">329</span>,<span class="number">347</span>,<span class="number">365</span>,</span><br><span class="line"><span class="number">383</span>,<span class="number">400</span>,<span class="number">417</span>,<span class="number">434</span>,<span class="number">449</span>,<span class="number">465</span>,<span class="number">479</span>,<span class="number">493</span>,<span class="number">506</span>,<span class="number">518</span>,</span><br><span class="line"><span class="number">530</span>,<span class="number">540</span>,<span class="number">549</span>,<span class="number">558</span>,<span class="number">565</span>,<span class="number">571</span>,<span class="number">576</span>,<span class="number">580</span>,<span class="number">583</span>,<span class="number">585</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Init */</span></span><br><span class="line"><span class="comment">//interrupt void INT_Timer(void);</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T1</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 控制左数1-4盏灯</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T1CINT</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第1盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP1</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第2盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP2</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第3盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP3</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第4盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T3</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 控制左数5-8盏灯</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T3CINT</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第5盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP4</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第6盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP5</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第7盏</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP6</span><span class="params">(<span class="type">void</span>)</span>;<span class="comment">// 左数第8盏</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Init_Sys</span><span class="params">(<span class="type">void</span>)</span> <span class="comment">/*初始化系统*/</span></span><br><span class="line">&#123;</span><br><span class="line">  SysCtrlRegs.PLLCR.all=<span class="number">0xA</span>;</span><br><span class="line">  SysCtrlRegs.PCLKCR.all=<span class="number">0xffff</span>;<span class="comment">//使能外设时钟</span></span><br><span class="line">  SysCtrlRegs.HISPCP.all=<span class="number">0x1</span>;   <span class="comment">//default默认设置</span></span><br><span class="line">  SysCtrlRegs.LOSPCP.all=<span class="number">0x2</span>;   <span class="comment">//default</span></span><br><span class="line">  SysCtrlRegs.WDCR=<span class="number">0x68</span>;    <span class="comment">//disable w d</span></span><br><span class="line">  SysCtrlRegs.LPMCR0.all=<span class="number">0x0</span>;   <span class="comment">//Low power --Idle</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitGpio</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    GpioMuxRegs.GPFMUX.all=<span class="number">0x00ff</span>;    <span class="comment">//f8~f13配置为通用io口</span></span><br><span class="line">    GpioMuxRegs.GPFDIR.all=<span class="number">0x3f00</span>;<span class="comment">//方向设置为输出</span></span><br><span class="line">    GpioDataRegs.GPFDAT.all=<span class="number">0x0700</span>;<span class="comment">//右边三灯先行亮起</span></span><br><span class="line"></span><br><span class="line">    GpioMuxRegs.GPEMUX.all=<span class="number">0x0</span>;   <span class="comment">//e口全io</span></span><br><span class="line">    GpioMuxRegs.GPEDIR.all=<span class="number">0xFF</span>;<span class="comment">//全输出</span></span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">0xFFFF</span>;<span class="comment">//全1</span></span><br><span class="line"></span><br><span class="line">    GpioMuxRegs.GPBMUX.all=<span class="number">0x0</span>;   <span class="comment">//b口全io，但只用到高8位</span></span><br><span class="line">    GpioMuxRegs.GPBDIR.all=<span class="number">0xFF00</span>;<span class="comment">//高8位为输出</span></span><br><span class="line">    GpioDataRegs.GPBDAT.all=<span class="number">0xff00</span>;<span class="comment">//高8位全为1，全熄灭</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">0xFFFA</span>;<span class="comment">//e口最低位1010/////////为什么这里要先行配置e口</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">0xFFFB</span>;<span class="comment">//e口最低位1011，锁存</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">0xFFFF</span>;<span class="comment">//e口低位1111，锁存</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitCputimer</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    CpuTimer0Regs.TPR.all = <span class="number">149</span>;</span><br><span class="line">    CpuTimer0Regs.TPRH.all= <span class="number">0</span>;</span><br><span class="line">    CpuTimer0Regs.PRD.all = <span class="number">999999</span>; <span class="comment">// 1秒一个timer0中断</span></span><br><span class="line">    CpuTimer0Regs.TCR.all =<span class="number">0xf000</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitCpuINT</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    <span class="comment">//extern cregister volatile unsigned int IFR;</span></span><br><span class="line">    <span class="comment">//extern cregister volatile unsigned int IER;</span></span><br><span class="line">    IFR = <span class="number">0x0</span>;</span><br><span class="line">    IER = <span class="number">0x000f</span>; <span class="comment">// 0xA for 1010 - INT2 &amp; INT4</span></span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitPIE</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EALLOW;</span><br><span class="line">    PieCtrlRegs.PIEIFR1.all = <span class="number">0x0000</span>;</span><br><span class="line"><span class="comment">//    PieCtrlRegs.PIEIER1.all = 0x0040;</span></span><br><span class="line">    PieCtrlRegs.PIEIFR2.all = <span class="number">0x0000</span>; <span class="comment">// 初始清零</span></span><br><span class="line">    PieCtrlRegs.PIEIER2.all = <span class="number">0x001f</span>; <span class="comment">// INT2.1 - INT2.5</span></span><br><span class="line">    PieCtrlRegs.PIEIFR4.all = <span class="number">0x0000</span>;</span><br><span class="line">    PieCtrlRegs.PIEIER4.all = <span class="number">0x001f</span>; <span class="comment">// INT4.1 - INT4.5</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all =<span class="number">0x0</span>;<span class="comment">//错误点</span></span><br><span class="line">    PieCtrlRegs.PIECRTL.all=<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 中断函数定义 */</span></span><br><span class="line"><span class="comment">//    PieVectTable.TINT0 = &amp; INT_Timer;</span></span><br><span class="line">    PieVectTable.T1PINT = &amp; INT_T1;</span><br><span class="line">    PieVectTable.CMP1INT = &amp; INT_CMP1;</span><br><span class="line">    PieVectTable.CMP2INT = &amp; INT_CMP2;</span><br><span class="line">    PieVectTable.CMP3INT = &amp; INT_CMP3;</span><br><span class="line">    PieVectTable.T1CINT = &amp; INT_T1CINT;</span><br><span class="line">    PieVectTable.T3PINT = &amp; INT_T3;</span><br><span class="line">    PieVectTable.CMP4INT = &amp; INT_CMP4;</span><br><span class="line">    PieVectTable.CMP5INT = &amp; INT_CMP5;</span><br><span class="line">    PieVectTable.CMP6INT = &amp; INT_CMP6;</span><br><span class="line">    PieVectTable.T3CINT = &amp; INT_T3CINT;</span><br><span class="line">    EDIS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitEva</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EvaRegs.EXTCONA.all=<span class="number">1</span>;</span><br><span class="line">    EvaRegs.GPTCONA.all=<span class="number">0x0010</span>;<span class="comment">//定时器1比较输出使能,比较输出极性为强制低,因为用不到pwm波</span></span><br><span class="line">    EvaRegs.T1CON.all=<span class="number">0x17ca</span>;<span class="comment">//0001 0111 1100 1010连续增计数、预定标因子为/128,重载条件为立即重载，避免因为装载时间造成显示不准</span></span><br><span class="line">    EvaRegs.T1PR   =<span class="number">586</span>;</span><br><span class="line">    EvaRegs.COMCONA.all=<span class="number">0x82e0</span>;<span class="comment">//1000 0010 1110 0000使能比较操作，使能比较器输出，对比较器1/2/3输出使能</span></span><br><span class="line">    EvaRegs.ACTRA.all=<span class="number">0x1</span>;<span class="comment">//比较输出引脚CMP1输出极性设置为低有效,但其实并不用到此引脚</span></span><br><span class="line">    EvaRegs.DBTCONA.all=<span class="number">0</span>;<span class="comment">//不加死区控制</span></span><br><span class="line">    EvaRegs.T1CMPR=index;</span><br><span class="line">    EvaRegs.CMPR1=index+<span class="number">7</span>;</span><br><span class="line">    EvaRegs.CMPR2=index+<span class="number">14</span>;</span><br><span class="line">    EvaRegs.CMPR3=index+<span class="number">21</span>;</span><br><span class="line">    EvaRegs.EVAIMRA.all=<span class="number">0x018e</span>;<span class="comment">//0000 0001 1000 1110定时器1比较和周期中断使能，比较单元1/2/3比较中断使能</span></span><br><span class="line">    EvaRegs.EVAIFRA.all=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">InitEvb</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EvbRegs.EXTCONB.all=<span class="number">1</span>;</span><br><span class="line">    EvbRegs.GPTCONB.all=<span class="number">0x0010</span>;<span class="comment">//定时器3比较输出使能,比较输出极性为强制低,因为用不到pwm波</span></span><br><span class="line">    EvbRegs.T3CON.all=<span class="number">0x17ca</span>;<span class="comment">//0001 0111 1100 1010连续增计数、预定标因子为/128,重载条件为立即重载，避免因为装载时间造成显示不准</span></span><br><span class="line">    EvbRegs.T3PR   =<span class="number">586</span>;</span><br><span class="line">    EvbRegs.COMCONB.all=<span class="number">0x82e0</span>;<span class="comment">//1000 0010 1110 0000使能比较操作，使能比较器输出，对比较器4/5/6输出使能</span></span><br><span class="line">    EvbRegs.ACTRB.all=<span class="number">0x1</span>;<span class="comment">//比较输出引脚CMP1输出极性设置为低有效</span></span><br><span class="line">    EvbRegs.DBTCONB.all=<span class="number">0</span>;<span class="comment">//不加死区控制</span></span><br><span class="line">    EvbRegs.T3CMPR=index+<span class="number">28</span>;</span><br><span class="line">    EvbRegs.CMPR4=index+<span class="number">35</span>;</span><br><span class="line">    EvbRegs.CMPR5=index+<span class="number">42</span>;</span><br><span class="line">    EvbRegs.CMPR6=index+<span class="number">49</span>;</span><br><span class="line">    EvbRegs.EVBIMRA.all=<span class="number">0x018e</span>;<span class="comment">//0000 0001 1000 1110定时器1比较和周期中断使能，比较单元1/2/3比较中断使能</span></span><br><span class="line">    EvbRegs.EVBIFRA.all=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Functions */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Out_redled</span> <span class="params">(redled)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    GpioDataRegs.GPBDAT.all=redled;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">7</span>;</span><br><span class="line">    <span class="comment">//点右边灯</span></span><br><span class="line">    GpioDataRegs.GPBDAT.all=redled*<span class="number">256</span>;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;&#125;</span><br><span class="line">    GpioDataRegs.GPEDAT.all=<span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">CPU_timer0_isr</span><span class="params">()</span>&#123;</span><br><span class="line">    PieCtrlRegs.PIEACK.all=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 只在这个中断里更改times和index */</span></span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T1</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 控制左数1-8盏灯</span></span><br><span class="line">    redled = <span class="number">0xff00</span>; <span class="comment">// 点亮最左边8盏</span></span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    <span class="type">int</span> i;<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (++times == <span class="number">20</span>)&#123;</span><br><span class="line">        times = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (++index == <span class="number">100</span>) &#123;</span><br><span class="line">            index = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EvaRegs.T1CMPR = led_tab[index];</span><br><span class="line">        EvaRegs.CMPR1 = led_tab[(index +<span class="number">7</span>)%<span class="number">100</span>];</span><br><span class="line">        EvaRegs.CMPR2 = led_tab[(index +<span class="number">7</span>*<span class="number">2</span>)%<span class="number">100</span>];</span><br><span class="line">        EvaRegs.CMPR3 = led_tab[(index +<span class="number">7</span>*<span class="number">3</span>)%<span class="number">100</span>];</span><br><span class="line">        EvbRegs.T3CMPR = led_tab[(index +<span class="number">7</span>*<span class="number">4</span>)%<span class="number">100</span>];</span><br><span class="line">        EvbRegs.CMPR4 = led_tab[(index +<span class="number">7</span>*<span class="number">5</span>)%<span class="number">100</span>];</span><br><span class="line">        EvbRegs.CMPR5 = led_tab[(index +<span class="number">7</span>*<span class="number">6</span>)%<span class="number">100</span>];</span><br><span class="line">        EvbRegs.CMPR6 = led_tab[(index +<span class="number">7</span>*<span class="number">7</span>)%<span class="number">100</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    EvaRegs.EVAIFRA.bit.T1PINT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    EvbRegs.EVBIFRA.bit.T3PINT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T3</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    EvbRegs.EVBIFRA.bit.T3PINT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T1CINT</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 左数第1盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x0101</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvaRegs.EVAIFRA.bit.T1CINT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP1</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 左数第二盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x0202</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvaRegs.EVAIFRA.bit.CMP1INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP2</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 左数第三盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x0404</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvaRegs.EVAIFRA.bit.CMP2INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP3</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">// 左数第四盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x0808</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvaRegs.EVAIFRA.bit.CMP3INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_T3CINT</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//左数第五盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x1010</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvbRegs.EVBIFRA.bit.T3CINT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP4</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//左数第六盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x2020</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvbRegs.EVBIFRA.bit.CMP4INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP5</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//左数第七盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x4040</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvbRegs.EVBIFRA.bit.CMP5INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line">interrupt <span class="type">void</span> <span class="title function_">INT_CMP6</span><span class="params">(<span class="type">void</span>)</span>&#123; <span class="comment">//左数第八盏</span></span><br><span class="line">    redled = redled ^ <span class="number">0x8080</span>;</span><br><span class="line">    Out_redled(redled);</span><br><span class="line">    EvbRegs.EVBIFRA.bit.CMP6INT = <span class="number">1</span>; <span class="comment">// 中断清除</span></span><br><span class="line">    PieCtrlRegs.PIEACK.all = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Main */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    DINT;</span><br><span class="line">    EALLOW;</span><br><span class="line">    Init_Sys();</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;&#125;</span><br><span class="line">    InitGpio();</span><br><span class="line"><span class="comment">//    InitCputimer();</span></span><br><span class="line">    InitCpuINT();</span><br><span class="line">    InitPIE();</span><br><span class="line">    InitEva();</span><br><span class="line">    InitEvb();</span><br><span class="line">    PieCtrlRegs.PIEACK.all =<span class="number">10</span>;</span><br><span class="line">    EDIS;</span><br><span class="line">    EINT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;<span class="keyword">asm</span>(<span class="string">&quot; IDLE&quot;</span>);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/ParadoxTZ">Paradox</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="http://zju-paradox.top/2023/09/28/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%EF%BC%88DSP%EF%BC%89/">http://zju-paradox.top/2023/09/28/微机原理（DSP）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">此文章版权归Paradox所有，如有转载，请注明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E5%A4%A7%E4%B8%89/">大三</a><a class="post-meta__tags" href="/tags/%E7%94%B5%E6%B0%94/">电气</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%BA/">微机</a></div><div class="post_share"><div class="social-share" data-image="https://img2.baidu.com/it/u=1235612171,3868693941&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=281" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/10/02/AI%E7%BB%98%E7%94%BB/" title="纯小白也能变大画师？SD：AI绘画的神！"><img class="cover" src="https://img1.baidu.com/it/u=161683432,2488264310&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=800&amp;h=500" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">纯小白也能变大画师？SD：AI绘画的神！</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/27/%E5%A4%A7%E4%BA%8C%E4%B8%8A%E7%AD%94%E6%A1%88/" title="电气学院大二（秋冬）课程资料整理（部分）"><img class="cover" src="https://ts1.cn.mm.bing.net/th/id/R-C.b6dd0a146e59761c7f9584de66901a3a?rik=QQ0sa%2bmrhe2vzQ&amp;riu=http%3a%2f%2fwww.creaform3d.com.cn%2fsites%2fdefault%2ffiles%2fstyles%2fgallery-block-view-featured%2fpublic%2fassets%2fservices%2fgalleries%2f3d-engineering%2felectronical-engineering%2f800x600%2fgenie-electrique.jpg&amp;ehk=282naUhv8%2faK15tP3wpK7UIbw7SVjxSfdZ%2fecSQQ3Hw%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">电气学院大二（秋冬）课程资料整理（部分）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/12/27/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%E8%AF%BE%E6%9C%AC%E5%A4%96%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85/" title="微机原理课本外知识点补充"><img class="cover" src="/image/DZ.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-27</div><div class="title">微机原理课本外知识点补充</div></div></a></div><div><a href="/2024/04/27/%E8%BF%90%E7%AD%B9%E5%AD%A6/" title="运筹学 Cheating Sheet（微雕）分享"><img class="cover" src="/image/keyan.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-27</div><div class="title">运筹学 Cheating Sheet（微雕）分享</div></div></a></div><div><a href="/2024/04/18/%E7%94%B5%E5%8A%9B%E7%94%B5%E5%AD%90%E6%8A%80%E6%9C%AF/" title="电力电子技术"><img class="cover" src="/image/zjutop3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-18</div><div class="title">电力电子技术</div></div></a></div><div><a href="/2024/04/02/%E7%94%B5%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%BB%BA%E6%A8%A1%E4%B8%8E%E5%88%86%E6%9E%90/" title="电机系统建模与分析"><img class="cover" src="/image/Fufu.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">电机系统建模与分析</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/dog.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Paradox</div><div class="author-info__description">未知苦处，不信神佛</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ParadoxTZ"><i class="fab fa-github"></i><span>个人主页(Github)</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ParadoxTZ" target="_blank" title="Github"><i class="fab fa-github" style="color:#000"></i></a><a class="social-icon" href="mailto:420907574@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#000"></i></a><a class="social-icon" href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;__biz=Mzg3MDk3NzYwOQ==" target="_blank" title="Wechat"><i class="fab fa-weixin" style="color:#000"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">玩得开心！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">课程笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E4%B8%8E%E7%B3%BB%E7%BB%9F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.1.</span> <span class="toc-text">时钟与系统控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gpio"><span class="toc-number">1.2.</span> <span class="toc-text">GPIO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cpu%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">CPU定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD"><span class="toc-number">1.4.</span> <span class="toc-text">中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%99%A8%E4%B8%8E%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.5.</span> <span class="toc-text">存储器与寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%99%A8%E4%B8%8Ecmd"><span class="toc-number">1.5.1.</span> <span class="toc-text">存储器与CMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">寄存器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%B2%E8%A1%8C%E5%A4%96%E8%AE%BE%E6%8E%A5%E5%8F%A3spi"><span class="toc-number">1.6.</span> <span class="toc-text">串行外设接口SPI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8ev"><span class="toc-number">1.7.</span> <span class="toc-text">事件管理器EV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%A8%A1%E8%BD%AC%E6%8D%A2%E5%99%A8adc"><span class="toc-number">1.8.</span> <span class="toc-text">数模转换器ADC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#c%E8%AF%AD%E8%A8%80%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">C语言代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%A1%86%E6%9E%B6"><span class="toc-number">2.1.</span> <span class="toc-text">基本代码定义与框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E8%84%9A%E5%AE%9A%E4%B9%89%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text">引脚定义实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%97%B6%E9%92%9Fpll%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.2.</span> <span class="toc-text">控制时钟PLL初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%8B%E9%97%A8%E7%8B%97%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.3.</span> <span class="toc-text">看门狗初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E8%AE%BE%E6%97%B6%E9%92%9F%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.4.</span> <span class="toc-text">外设时钟初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E5%88%9D%E5%A7%8B%E5%8C%96-initsysctrl"><span class="toc-number">2.1.5.</span> <span class="toc-text">总初始化 InitSysCtrl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%B3%951"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">写法1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%B3%952"><span class="toc-number">2.1.5.2.</span> <span class="toc-text">写法2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gpio%E5%88%9D%E5%A7%8B%E5%8C%96-initgpio"><span class="toc-number">2.1.6.</span> <span class="toc-text">GPIO初始化 InitGpio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cpu%E5%AE%9A%E6%97%B6%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96-initcputimer"><span class="toc-number">2.1.7.</span> <span class="toc-text">CPU定时器初始化 InitCPUtimer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%92%9F%E5%BB%B6%E6%97%B6%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.8.</span> <span class="toc-text">时钟延时函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pie%E4%B8%AD%E6%96%AD%E5%88%9D%E5%A7%8B%E5%8C%96-initpie"><span class="toc-number">2.1.9.</span> <span class="toc-text">PIE中断初始化 InitPIE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E7%9A%84%E7%94%B3%E8%AF%B7"><span class="toc-number">2.1.10.</span> <span class="toc-text">中断向量的申请</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cpu%E4%B8%AD%E6%96%AD%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.11.</span> <span class="toc-text">CPU中断初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spi%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.12.</span> <span class="toc-text">SPI初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spi%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81"><span class="toc-number">2.1.13.</span> <span class="toc-text">SPI数据发送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E7%BA%A2%E7%81%AF%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.14.</span> <span class="toc-text">点红灯函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E6%AE%B5%E6%95%B0%E7%A0%81%E7%AE%A1%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.1.15.</span> <span class="toc-text">八段数码管循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="toc-number">2.1.16.</span> <span class="toc-text">键盘的读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E9%94%AE%E7%9B%98%E8%BE%93%E5%85%A5"><span class="toc-number">2.1.17.</span> <span class="toc-text">等待键盘输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E5%8F%B7%E5%88%A4%E5%88%AB%E5%8A%9F%E8%83%BD%E8%BD%AC%E7%A7%BB"><span class="toc-number">2.1.18.</span> <span class="toc-text">键号判别、功能转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8%E7%BC%96%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.19.</span> <span class="toc-text">通用定时器编程初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEpwm%E6%B3%A2%E5%91%A8%E6%9C%9F%E6%B3%A2%E5%BD%A2"><span class="toc-number">2.1.20.</span> <span class="toc-text">设置PWM波周期波形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adc%E4%B8%8A%E7%94%B5"><span class="toc-number">2.1.21.</span> <span class="toc-text">ADC上电</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adc%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.22.</span> <span class="toc-text">ADC初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adc%E8%B0%83%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.23.</span> <span class="toc-text">ADC调用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E4%B8%8E%E7%BA%A2%E7%81%AF%E7%9A%84%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.1.24.</span> <span class="toc-text">键盘与红灯的冲突解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B1-%E7%82%B9%E7%81%AF"><span class="toc-number">2.2.1.</span> <span class="toc-text">实例1 点灯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B2-%E4%B8%AD%E6%96%AD%E7%BC%96%E7%A8%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">实例2 中断编程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B3-%E7%BB%BF%E7%81%AF%E9%97%AA%E7%83%81%E7%82%B9%E7%BA%A2%E7%81%AF"><span class="toc-number">2.2.3.</span> <span class="toc-text">实例3 绿灯闪烁+点红灯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B4-%E9%94%AE%E7%9B%98%E5%93%8D%E5%BA%94%E6%97%B6%E9%92%9Fad%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.2.4.</span> <span class="toc-text">实例4 键盘响应+时钟+AD转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B5-%E8%B7%91%E9%A9%AC%E7%81%AF%E6%AD%A3%E5%BC%A6%E4%BA%AE%E5%BA%A6%E5%8F%98%E5%8C%96"><span class="toc-number">2.2.5.</span> <span class="toc-text">实例5 跑马灯——正弦亮度变化</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/04/27/%E8%BF%90%E7%AD%B9%E5%AD%A6/" title="运筹学 Cheating Sheet（微雕）分享"><img src="/image/keyan.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="运筹学 Cheating Sheet（微雕）分享"></a><div class="content"><a class="title" href="/2024/04/27/%E8%BF%90%E7%AD%B9%E5%AD%A6/" title="运筹学 Cheating Sheet（微雕）分享">运筹学 Cheating Sheet（微雕）分享</a><time datetime="2024-04-27T07:08:45.727Z" title="发表于 2024-04-27 15:08:45">2024-04-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/18/%E7%94%B5%E5%8A%9B%E7%94%B5%E5%AD%90%E6%8A%80%E6%9C%AF/" title="电力电子技术"><img src="/image/zjutop3.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="电力电子技术"></a><div class="content"><a class="title" href="/2024/04/18/%E7%94%B5%E5%8A%9B%E7%94%B5%E5%AD%90%E6%8A%80%E6%9C%AF/" title="电力电子技术">电力电子技术</a><time datetime="2024-04-18T06:46:34.042Z" title="发表于 2024-04-18 14:46:34">2024-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/02/%E7%94%B5%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%BB%BA%E6%A8%A1%E4%B8%8E%E5%88%86%E6%9E%90/" title="电机系统建模与分析"><img src="/image/Fufu.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="电机系统建模与分析"></a><div class="content"><a class="title" href="/2024/04/02/%E7%94%B5%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%BB%BA%E6%A8%A1%E4%B8%8E%E5%88%86%E6%9E%90/" title="电机系统建模与分析">电机系统建模与分析</a><time datetime="2024-04-02T06:00:15.080Z" title="发表于 2024-04-02 14:00:15">2024-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/15/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E7%A8%8B%E6%80%BB%E7%BB%93/" title="大三（秋冬）课程总结"><img src="/image/%E5%B0%81%E9%9D%A2.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="大三（秋冬）课程总结"></a><div class="content"><a class="title" href="/2024/01/15/%E5%A4%A7%E4%B8%89%E4%B8%8A%E8%AF%BE%E7%A8%8B%E6%80%BB%E7%BB%93/" title="大三（秋冬）课程总结">大三（秋冬）课程总结</a><time datetime="2024-01-15T07:31:06.092Z" title="发表于 2024-01-15 15:31:06">2024-01-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/27/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%E8%AF%BE%E6%9C%AC%E5%A4%96%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85/" title="微机原理课本外知识点补充"><img src="/image/DZ.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="微机原理课本外知识点补充"></a><div class="content"><a class="title" href="/2023/12/27/%E5%BE%AE%E6%9C%BA%E5%8E%9F%E7%90%86%E8%AF%BE%E6%9C%AC%E5%A4%96%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85/" title="微机原理课本外知识点补充">微机原理课本外知识点补充</a><time datetime="2023-12-27T07:28:57.562Z" title="发表于 2023-12-27 15:28:57">2023-12-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/image/top3.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Paradox</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://paradoxtz.zeabur.app',
      region: 'ap-hangzhou',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://paradoxtz.zeabur.app',
      region: 'ap-hangzhou',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.textContent = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>